name: Deploy Frontend to Oracle

on:
  push:
    branches: [devops] # your deployment branch

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.FRONTEND_DEV_STAGING_CLERK }}
      CLERK_PUBLISHABLE_KEY: ${{ secrets.FRONTEND_DEV_STAGING_CLERK }}

    steps:
      # Step 1: Checkout code
      - name: Checkout repo
        uses: actions/checkout@v3

      # Step 2: Setup pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      # Step 3: Install dependencies
      - name: Install dependencies
        run: pnpm install

      # Step 4: Build workspace packages
      - name: Build workspace packages
        run: |
          pnpm --filter @trustmed/types build
          pnpm --filter @trustmed/components run --if-present build

      # Step 5: Build frontend
      - name: Build Next.js frontend
        run: pnpm --filter @trustmed/core-frontend build

      # Step 5.1: Verify build artifacts
      - name: Check build output
        run: |
          ls -la apps/core-frontend
          ls -la apps/core-frontend/.next

      # Step 6: Deploy built files to Oracle VM
      - name: Deploy built files to Oracle VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.FRONTEND_DEV_STAGING_IP }}
          username: ${{ secrets.FRONTEND_DEV_STAGING_SERVER_USER }}
          key: ${{ secrets.FRONTEND_STAGING_DEV_SSH_SECRET }}
          debug: true
          source: apps/core-frontend/.next
          strip_components: 2
          target: /home/ubuntu/frontend

      # Step 6.1: Deploy public folder
      - name: Deploy public folder
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.FRONTEND_DEV_STAGING_IP }}
          username: ${{ secrets.FRONTEND_DEV_STAGING_SERVER_USER }}
          key: ${{ secrets.FRONTEND_STAGING_DEV_SSH_SECRET }}
          debug: true
          source: apps/core-frontend/public
          strip_components: 2
          target: /home/ubuntu/frontend

      # Step 7: Restart frontend with PM2 safely
      - name: Restart frontend on Oracle VM
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.FRONTEND_DEV_STAGING_IP }}
          username: ${{ secrets.FRONTEND_DEV_STAGING_SERVER_USER }}
          key: ${{ secrets.FRONTEND_STAGING_DEV_SSH_SECRET }}
          env:
            NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.FRONTEND_DEV_STAGING_CLERK }}
            CLERK_SECRET_KEY: ${{ secrets.FRONTEND_DEV_STAGING_CLERK_SECRET }}
          script: |
            # Clean up incorrect nested structure from previous deployment
            rm -rf /home/ubuntu/frontend/core-frontend || true

            # Create .env.local with Clerk secrets
            cat > /home/ubuntu/frontend/.env.local << 'EOF'
            NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=${{ secrets.FRONTEND_DEV_STAGING_CLERK }}
            CLERK_SECRET_KEY=${{ secrets.FRONTEND_DEV_STAGING_CLERK_SECRET }}
            EOF

            # Stop & delete old PM2 process if exists
            pm2 delete frontend 2>/dev/null || true

            # Start frontend using standalone server with env file
            PORT=3000 NODE_ENV=production pm2 start /home/ubuntu/frontend/.next/standalone/apps/core-frontend/server.js --name frontend

            # Save PM2 process for auto-restart on reboot
            pm2 save